# Анализ архитектуры TutorAI для расчета рейтинга слушателей

## Текущая архитектура базы данных

### Основные сущности:

1. **Student** (Студент)
   - `student_id` - уникальный идентификатор
   - `name` - имя студента
   - `phone` - телефон
   - `telegram_user_id` - ID в Telegram
   - `is_active` - активен ли студент
   - `course_program_id` - ссылка на программу курса
   - `last_login_at` - время последнего входа

2. **CourseProgram** (Программа курса)
   - `program_id` - уникальный идентификатор
   - `name` - название программы
   - `total_hours` - общее количество часов

3. **Stream** (Поток/группа)
   - `stream_id` - уникальный идентификатор
   - `program_id` - ссылка на программу
   - `name` - название потока
   - `start_date`, `end_date` - даты начала и окончания

4. **Module** (Модуль курса)
   - `module_id` - уникальный идентификатор
   - `program_id` - ссылка на программу
   - `duration_hours` - общая длительность
   - `lecture_hours`, `practice_hours`, `independent_hours` - распределение часов
   - `is_intermediate_attestation`, `is_final_attestation` - флаги аттестаций

5. **Lesson** (Урок)
   - `lesson_id` - уникальный идентификатор
   - `module_id` - ссылка на модуль
   - `duration_hours` - длительность урока

6. **Assignment** (Задание)
   - `assignment_id` - уникальный идентификатор
   - `student_id`, `lesson_id` - связи
   - `status` - статус выполнения (PENDING, SUBMITTED, CHECKED, COMPLETED)
   - `deadline` - срок сдачи
   - `grade` - оценка
   - `submitted_at`, `checked_at` - даты отправки и проверки

7. **Meeting** (Занятие)
   - `meeting_id` - уникальный идентификатор
   - `stream_id`, `lesson_id` - связи
   - `meeting_type` - тип занятия (LECTURE, PRACTICE, INDEPENDENT)
   - `meeting_date` - дата занятия

8. **Schedule** (Расписание)
   - `schedule_id` - уникальный идентификатор
   - `stream_id`, `lesson_id` - связи
   - `scheduled_date` - запланированная дата
   - `is_completed` - завершено ли занятие

## Необходимые поля для расчета рейтинга

### Обязательные поля (уже существуют):

1. **Оценки за задания:**
   - `Assignment.grade` - числовая оценка
   - `Assignment.status` - статус выполнения
   - `Assignment.deadline` - срок сдачи для расчета своевременности
   - `Assignment.submitted_at` - дата отправки

2. **Прогресс по курсу:**
   - `Lesson.duration_hours` - длительность уроков
   - `Module.duration_hours` - длительность модулей
   - `CourseProgram.total_hours` - общая длительность курса

3. **Посещаемость занятий:**
   - `Meeting.meeting_date` - дата занятия
   - `Meeting.meeting_type` - тип занятия
   - Нужна дополнительная сущность для отметки посещения

4. **Своевременность выполнения:**
   - `Assignment.submitted_at` - дата отправки
   - `Assignment.deadline` - срок сдачи

### Отсутствующие поля (требуют добавления):

1. **Таблица посещаемости** - для точного учета присутствия на занятиях
2. **Статистика активности** - для отслеживания взаимодействия с платформой
3. **Веса заданий** - для дифференцированной оценки важности заданий

## Предлагаемая формула расчета рейтинга

### Компоненты рейтинга:

1. **Академическая успеваемость (50%):**
   ```
   Академическая_успеваемость = (Средняя_оценка × Коэффициент_своевременности) × 0.5
   
   Средняя_оценка = Σ(grade) / Количество_заданий_со_статусом_CHECKED_или_COMPLETED
   
   Коэффициент_своевременности = Σ(Коэффициент_задания) / Количество_заданий
   
   Коэффициент_задания:
     - 1.0 если submitted_at <= deadline
     - 0.8 если submitted_at > deadline и submitted_at <= deadline + 3 дня
     - 0.6 если submitted_at > deadline + 3 дня и submitted_at <= deadline + 7 дней
     - 0.4 если submitted_at > deadline + 7 дней
   ```

2. **Посещаемость (25%):**
   ```
   Посещаемость = (Процент_посещенных × Коэффициент_типа_занятия) × 0.25
   
   Процент_посещенных = (Количество_посещенных_занятий / Общее_количество_занятий) × 100
   
   Коэффициент_типа_занятия = Σ(Коэффициент_занятия) / Количество_занятий
   
   Коэффициент_занятия:
     - 1.2 для PRACTICE
     - 1.0 для LECTURE
     - 0.8 для INDEPENDENT
   ```

3. **Активность (15%):**
   ```
   Активность = (Коэффициент_частоты × Коэффициент_последней_активности) × 0.15
   
   Коэффициент_частоты = MIN(total_login_count / 30, 1.0)  # максимум 30 входов в месяц
   
   Коэффициент_последней_активности:
     - 1.0 если last_activity_at в течение последних 7 дней
     - 0.7 если last_activity_at от 8 до 30 дней назад
     - 0.3 если last_activity_at более 30 дней назад
   ```

4. **Прогресс (10%):**
   ```
   Прогресс = (Процент_пройденного × Коэффициент_скорости) × 0.1
   
   Процент_пройденного = (Количество_пройденных_уроков / Общее_количество_уроков) × 100
   
   Коэффициент_скорости:
     - 1.2 если прогресс > 110% от ожидаемого
     - 1.0 если прогресс от 90% до 110%
     - 0.8 если прогресс < 90%
   ```

### Итоговая формула:
```
Общий рейтинг = Академическая_успеваемость + Посещаемость + Активность + Прогресс
```

## Рекомендации по реализации

1. **Сначала добавить таблицу посещаемости** - это критически важно для расчета рейтинга
2. **Расширить таблицу заданий** дополнительными полями для весов
3. **Создать систему отслеживания активности** для учета взаимодействия с платформой
4. **Реализовать настраиваемые веса** для разных курсов
5. **Создать SQL-представление** для быстрого расчета рейтинга

Эта архитектура позволит гибко настраивать систему рейтинга для разных курсов и обеспечит точный расчет успеваемости студентов.